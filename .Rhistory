message("→ Paper comparison figures (session vs follow-up): linear + spline")
make_paper_figures_comparison(results, out_dir = out_dir, df_spline = df_spline)
} else {
message("⚠️ Follow-up window missing: comparison not produced.")
}
invisible(results)
}
if (identical(environment(), globalenv())) {
run_main_analysis()
}
make_paper_figures_for_window <- function(
window_value,
es,
dr_mol,
dr_ae,
out_dir,
only_session = TRUE,
dr_mol_plot = NULL,
dr_ae_plot  = NULL,
model = NULL,
df_spline = NULL,
...
){
if (isTRUE(only_session) && window_value != "session") {
return(invisible(TRUE))
}
fig_dir <- file.path(out_dir, "paper_figures")
dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)
dr_ae_use <- if (!is.null(dr_ae_plot)) dr_ae_plot else dr_ae
if (!is.null(dr_ae_use) &&
!is.null(dr_ae_use$preds) &&
nrow(dr_ae_use$preds)) {
plot_fig3_dr_shared_aes_normalized(
preds_ae = dr_ae_use$preds,
es       = es,
outfile  = file.path(fig_dir, "Fig3_DR_sharedAEs.pdf")
)
}
invisible(TRUE)
}
# =========================
# FILE: R/dose_response_models.R
# =========================
suppressPackageStartupMessages({
library(dplyr)
library(purrr)
library(tibble)
library(metafor)
library(splines)
})
# ============================================================
# Effect sizes (OR) with Haldane–Anscombe correction only if 0-cells
# ============================================================
build_escalc <- function(contrasts, add = 0.5){
empty_tpl <- tibble(
study_id    = character(),
molecule    = character(),
ae_term     = character(),
time_window = character(),
dose_mg     = double(),
ref_dose_mg = double(),
dose_diff   = double(),
yi          = double(),
vi          = double()
)
if (is.null(contrasts) || !nrow(contrasts)) return(empty_tpl)
needed <- c("ai","bi","ci","di","study_id","molecule","ae_term",
"time_window","dose_mg","ref_dose_mg","dose_diff")
miss <- setdiff(needed, names(contrasts))
if (length(miss)) stop("build_escalc(): missing columns: ", paste(miss, collapse=", "))
esc <- metafor::escalc(
measure = "OR",
ai = ai, bi = bi, ci = ci, di = di,
data = contrasts,
add = add, to = "only0"
)
as_tibble(esc) %>%
transmute(
study_id    = as.character(study_id),
molecule    = toupper(as.character(molecule)),
ae_term     = as.character(ae_term),
time_window = as.character(time_window),
dose_mg     = as.numeric(dose_mg),
ref_dose_mg = as.numeric(ref_dose_mg),
dose_diff   = as.numeric(dose_diff),
yi          = as.numeric(yi),
vi          = as.numeric(vi)
) %>%
filter(is.finite(yi), is.finite(vi), is.finite(dose_mg))
}
# ============================================================
# Grid helper
# ============================================================
make_grid <- function(doses_obs, grid = c("observed","truncated","continuous"), n_grid = 120){
grid <- match.arg(grid)
doses_obs <- sort(unique(as.numeric(doses_obs)))
doses_obs <- doses_obs[is.finite(doses_obs)]
if (!length(doses_obs)) return(double())
if (grid == "observed") return(doses_obs)
if (grid == "truncated") {
if (length(doses_obs) < 3) return(doses_obs)
q <- stats::quantile(doses_obs, c(0.05, 0.95), na.rm = TRUE, names = FALSE)
return(doses_obs[doses_obs >= q[1] & doses_obs <= q[2]])
}
rng <- range(doses_obs, na.rm = TRUE)
if (!is.finite(rng[1]) || !is.finite(rng[2]) || rng[1] == rng[2]) return(doses_obs)
seq(rng[1], rng[2], length.out = n_grid)
}
# ============================================================
# Model fitting (linear or spline)
# ============================================================
fit_dr <- function(dat, model = c("linear","spline"), df_spline = 3){
model <- match.arg(model)
dat <- dat %>% filter(is.finite(yi), is.finite(vi), is.finite(dose_mg))
if (nrow(dat) < 2 || n_distinct(dat$dose_mg) < 2) return(NULL)
tryCatch({
if (model == "linear") {
metafor::rma(yi, vi, mods = ~ dose_mg, data = dat, method = "REML")
} else {
# natural spline basis in metafor via ns()
metafor::rma(yi, vi, mods = ~ splines::ns(dose_mg, df = df_spline), data = dat, method = "REML")
}
}, error = function(e) NULL)
}
make_newmods <- function(doses, model = c("linear","spline"), df_spline = 3){
model <- match.arg(model)
doses <- as.numeric(doses)
doses <- doses[is.finite(doses)]
if (!length(doses)) return(NULL)
if (model == "linear") {
return(matrix(doses, ncol = 1))
}
# IMPORTANT: predict.rma needs basis evaluated at new doses.
# Use ns(new, df) with same df; metafor will align with ns() used in model.
B <- splines::ns(doses, df = df_spline)
as.matrix(B)
}
predict_dr <- function(m, doses, model = c("linear","spline"), df_spline = 3){
model <- match.arg(model)
if (is.null(m) || !length(doses)) return(tibble())
newmods <- make_newmods(doses, model = model, df_spline = df_spline)
if (is.null(newmods)) return(tibble())
pr <- tryCatch(
predict(m, newmods = newmods),
error = function(e) NULL
)
if (is.null(pr)) return(tibble())
tibble(
dose_mg = as.numeric(doses),
fit = as.numeric(pr$pred),
lwr = as.numeric(pr$ci.lb),
upr = as.numeric(pr$ci.ub)
)
}
extract_pval <- function(m, model = c("linear","spline")){
model <- match.arg(model)
if (is.null(m)) return(NA_real_)
if (model == "linear") {
# p-value of slope term (dose_mg)
return(tryCatch(as.numeric(m$pval[2]), error = function(e) NA_real_))
}
# spline omnibus
return(tryCatch(as.numeric(m$QMp), error = function(e) NA_real_))
}
extract_beta <- function(m, model = c("linear","spline")){
model <- match.arg(model)
if (is.null(m)) return(NA_real_)
if (model == "linear") return(tryCatch(as.numeric(coef(m)[2]), error = function(e) NA_real_))
NA_real_ # spline has multiple coefficients; store NA
}
# ============================================================
# Global DR by molecule
# ============================================================
run_dr_by_molecule <- function(
es,
min_k = 2,
grid = c("observed","truncated","continuous"),
n_grid = 120,
model = c("linear","spline"),
df_spline = 3
){
grid <- match.arg(grid)
model <- match.arg(model)
es2 <- es %>%
filter(is.finite(yi), is.finite(vi), is.finite(dose_mg)) %>%
mutate(molecule = toupper(as.character(molecule))) %>%
group_by(molecule) %>%
filter(n() >= min_k, n_distinct(dose_mg) >= 2) %>%
ungroup()
preds <- map_dfr(split(es2, es2$molecule), function(g){
doses <- make_grid(g$dose_mg, grid = grid, n_grid = n_grid)
m <- fit_dr(g, model = model, df_spline = df_spline)
if (is.null(m)) return(tibble())
predict_dr(m, doses, model = model, df_spline = df_spline) %>%
mutate(
molecule = g$molecule[1],
model = model,
df_spline = ifelse(model == "spline", df_spline, NA_integer_)
)
})
models <- es2 %>%
split(.$molecule) %>%
map_dfr(function(g){
m <- fit_dr(g, model = model, df_spline = df_spline)
if (is.null(m)) return(tibble())
tibble(
molecule = g$molecule[1],
model = model,
df_spline = ifelse(model == "spline", df_spline, NA_integer_),
beta = extract_beta(m, model),
pval = extract_pval(m, model),
k = m$k,
QM = tryCatch(as.numeric(m$QM), error = function(e) NA_real_),
QMp = tryCatch(as.numeric(m$QMp), error = function(e) NA_real_),
I2 = tryCatch(as.numeric(m$I2), error = function(e) NA_real_)
)
})
list(preds = preds, models = models)
}
# ============================================================
# DR by AE × molecule
# ============================================================
run_dr_by_ae <- function(
es,
min_k = 2,
grid = c("observed","truncated","continuous"),
n_grid = 120,
model = c("linear","spline"),
df_spline = 3
){
grid <- match.arg(grid)
model <- match.arg(model)
es2 <- es %>%
filter(is.finite(yi), is.finite(vi), is.finite(dose_mg)) %>%
mutate(molecule = toupper(as.character(molecule))) %>%
group_by(molecule, ae_term) %>%
filter(n() >= min_k, n_distinct(dose_mg) >= 2) %>%
ungroup()
preds <- map_dfr(
split(es2, interaction(es2$molecule, es2$ae_term, drop = TRUE)),
function(g){
doses <- make_grid(g$dose_mg, grid = grid, n_grid = n_grid)
m <- fit_dr(g, model = model, df_spline = df_spline)
if (is.null(m)) return(tibble())
predict_dr(m, doses, model = model, df_spline = df_spline) %>%
mutate(
molecule = g$molecule[1],
ae_term  = g$ae_term[1],
model = model,
df_spline = ifelse(model == "spline", df_spline, NA_integer_)
)
}
)
models <- es2 %>%
split(interaction(es2$molecule, es2$ae_term, drop = TRUE)) %>%
map_dfr(function(g){
m <- fit_dr(g, model = model, df_spline = df_spline)
if (is.null(m)) return(tibble())
tibble(
molecule = g$molecule[1],
ae_term  = g$ae_term[1],
model = model,
df_spline = ifelse(model == "spline", df_spline, NA_integer_),
beta = extract_beta(m, model),
pval = extract_pval(m, model),
k = m$k
)
})
list(preds = preds, models = models)
}
make_paper_figures_for_window <- function(
window_value,
es,
dr_mol,
dr_ae,
out_dir,
only_session = TRUE,
dr_mol_plot = NULL,
dr_ae_plot  = NULL,
model = NULL,
df_spline = NULL,
...
){
if (isTRUE(only_session) && window_value != "session") {
return(invisible(TRUE))
}
fig_dir <- file.path(out_dir, "paper_figures")
dir.create(fig_dir, recursive = TRUE, showWarnings = FALSE)
dr_ae_use <- if (!is.null(dr_ae_plot)) dr_ae_plot else dr_ae
if (!is.null(dr_ae_use) &&
!is.null(dr_ae_use$preds) &&
nrow(dr_ae_use$preds)) {
plot_fig3_dr_shared_aes_normalized(
preds_ae = dr_ae_use$preds,
es       = es,
outfile  = file.path(fig_dir, "Fig3_DR_sharedAEs.pdf")
)
}
invisible(TRUE)
}
window_value,
# =========================
# FILE: run_main_analysis.R
# =========================
#!/usr/bin/env Rscript
suppressPackageStartupMessages({
library(here)
library(readxl)
library(dplyr)
library(purrr)
library(stringr)
library(readr)
})
# =============================================================================
# SOURCES
# =============================================================================
source(here::here("R", "compat_map_groups.R"))
source(here::here("R", "data_ingest.R"))            # load_data(), build_pairwise_2x2()
source(here::here("R", "dose_response_models.R"))   # build_escalc(), run_dr_*
source(here::here("R", "forest_plots.R"))
source(here::here("R", "dose_response_plots.R"))
source(here::here("R", "master_plots.R"))
source(here::here("R", "session_followup_dr_plots.R"))
source(here::here("R", "session_followup_forest_plots.R"))
source(here::here("R", "publication_figures.R"))
source(here::here("R", "bubble_weight_plots.R"))
source(here::here("R", "psilocybin_controls.R"))
# =============================================================================
# UTILITIES
# =============================================================================
safe_dir <- function(path){
dir.create(path, recursive = TRUE, showWarnings = FALSE)
invisible(path)
}
norm_window_label <- function(x) {
x <- tolower(trimws(as.character(x)))
dplyr::case_when(
x %in% c("session","acute","in-session","in session") ~ "session",
x %in% c("followup","follow-up","follow up","follow_up") ~ "follow_up",
TRUE ~ x
)
}
extract_study_year <- function(author_year){
as.integer(stringr::str_extract(as.character(author_year), "(19|20)\\d{2}"))
}
build_es_for_window <- function(raw, window_value, ref_policies) {
raw_w <- dplyr::filter(raw, time_window == window_value)
if (!nrow(raw_w)) return(tibble())
contrasts <- build_pairwise_2x2(raw_w, ref_policies = ref_policies)
if (is.null(contrasts) || !nrow(contrasts)) return(tibble())
es <- build_escalc(contrasts)
if ("study_id" %in% names(es) && all(c("study_id","study_year") %in% names(raw_w))) {
es <- es %>% left_join(raw_w %>% distinct(study_id, study_year), by = "study_id")
}
es
}
# =============================================================================
# DEFAULT REFERENCE POLICIES
# =============================================================================
default_ref_policies <- list(
MDMA       = c("inactive_placebo","active_non_psy_placebo","active_placebo"),
LSD        = c("inactive_placebo","active_non_psy_placebo","active_placebo"),
PSILOCYBIN = c("inactive_placebo","active_non_psy_placebo","active_placebo"),
AYAHUASCA  = c("inactive_placebo","active_non_psy_placebo","active_placebo"),
.default   = c("inactive_placebo","active_non_psy_placebo","active_placebo")
)
# =============================================================================
# MAIN
# =============================================================================
run_main_analysis <- function(
data_xlsx = here::here("data", "Adverse-events-dose-v5.xlsx"),
sheet     = "Feuil1",
out_dir   = here::here("results", "main"),
min_k     = 2,
df_spline = 3
) {
if (!file.exists(data_xlsx)) stop("Data file not found: ", data_xlsx)
safe_dir(out_dir)
message("1) Load & harmonize data …")
raw <- load_data(data_xlsx, sheet = sheet) %>%
mutate(time_window = norm_window_label(time_window))
if ("author_year" %in% names(raw)) {
raw <- raw %>% mutate(study_year = extract_study_year(author_year))
} else {
raw <- raw %>% mutate(study_year = NA_integer_)
}
if (exists("run_psilocybin_controls", mode = "function")) {
message("→ Controls: psilocybin (session) …")
try(run_psilocybin_controls(
data_xlsx   = data_xlsx,
sheet       = sheet,
out_dir     = here::here("results", "controls_psilocybin"),
window      = "session",
era_cutoff  = 2018
), silent = TRUE)
}
windows <- intersect(c("session","follow_up"), unique(raw$time_window))
if (!length(windows)) stop("No valid time windows in data.")
models_to_run <- list(
linear = list(model = "linear", df_spline = NA_integer_),
spline = list(model = "spline", df_spline = df_spline)
)
run_window <- function(w){
message("→ Window '", w, "': build effect sizes")
es <- build_es_for_window(raw, w, default_ref_policies)
if (!nrow(es)) return(NULL)
out_w <- file.path(out_dir, w)
safe_dir(out_w)
# Bubble weights (optional)
try({
bubble_dir <- file.path(out_w, "paper_figures")
safe_dir(bubble_dir)
plot_bubble_weights_by_molecule(
es       = es,
outfile  = file.path(bubble_dir, paste0("FigX_Bubble_weights_", w, ".pdf")),
top_n_ae = 16,
min_k_ae = 3
)
}, silent = TRUE)
# Forest plots (classic) (optional)
try({
make_forest_plots(es, file.path(out_w, "forest_plots"))
make_forest_plots_per_molecule_pdf(es, file.path(out_w, "forest_plots_by_molecule"))
make_forest_summary_per_molecule(es, file.path(out_w, "forest_plots_summary"))
}, silent = TRUE)
dr <- purrr::imap(models_to_run, function(spec, tag){
message("   → DR ", tag, " …")
out_tag <- file.path(out_w, tag)
safe_dir(out_tag)
# --- models + observed preds
dr_mol_obs <- run_dr_by_molecule(es, min_k = min_k, grid = "observed",
model = spec$model, df_spline = spec$df_spline)
dr_ae_obs  <- run_dr_by_ae(es, min_k = min_k, grid = "observed",
model = spec$model, df_spline = spec$df_spline)
# --- continuous preds for plotting
dr_mol_plot <- run_dr_by_molecule(es, min_k = min_k, grid = "continuous", n_grid = 200,
model = spec$model, df_spline = spec$df_spline)
dr_ae_plot  <- run_dr_by_ae(es, min_k = min_k, grid = "continuous", n_grid = 120,
model = spec$model, df_spline = spec$df_spline)
# --- tables
tab_dir <- file.path(out_tag, "tables")
safe_dir(tab_dir)
write_csv(dr_mol_obs$models, file.path(tab_dir, paste0("dr_models_by_molecule_", w, "_", tag, ".csv")))
write_csv(dr_ae_obs$models,  file.path(tab_dir, paste0("dr_models_by_ae_", w, "_", tag, ".csv")))
dr_ae_sig <- dr_ae_obs$models %>%
mutate(
p_adj_bh_global = p.adjust(pval, method = "BH")
) %>%
group_by(molecule) %>%
mutate(
p_adj_bh_by_mol = p.adjust(pval, method = "BH")
) %>%
ungroup() %>%
mutate(
sig_p05          = !is.na(pval) & pval < 0.05,
sig_fdr_global05 = !is.na(p_adj_bh_global) & p_adj_bh_global < 0.05,
sig_fdr_mol05    = !is.na(p_adj_bh_by_mol) & p_adj_bh_by_mol < 0.05
) %>%
arrange(pval)
write_csv(dr_ae_sig, file.path(tab_dir, paste0("dr_models_by_ae_", w, "_", tag, "_with_sig_flags.csv")))
write_csv(filter(dr_ae_sig, sig_p05),
file.path(tab_dir, paste0("dr_models_by_ae_", w, "_", tag, "_significant_p05.csv")))
write_csv(filter(dr_ae_sig, sig_fdr_global05),
file.path(tab_dir, paste0("dr_models_by_ae_", w, "_", tag, "_significant_fdr05_global.csv")))
write_csv(filter(dr_ae_sig, sig_fdr_mol05),
file.path(tab_dir, paste0("dr_models_by_ae_", w, "_", tag, "_significant_fdr05_by_molecule.csv")))
# --- standard DR plots (optional)
try({
dr_dir <- file.path(out_tag, "dose_response")
safe_dir(dr_dir)
plot_dr_by_molecule_split(dr_mol_plot$preds, outdir = file.path(dr_dir, "by_molecule"))
plot_dr_per_molecule_across_ae_facets(dr_ae_plot$preds, outdir = file.path(dr_dir, "by_ae_facets"))
plot_dr_per_ae_normalized_dose(dr_ae_plot$preds, outdir = file.path(dr_dir, "by_ae_normalized"))
}, silent = TRUE)
# --- master plots (optional)
try({
master_dir <- file.path(out_tag, "master")
safe_dir(master_dir)
plot_master_dr_by_molecule(dr_mol_plot$preds, outfile = file.path(master_dir, paste0("master_dr_by_molecule_", tag, ".pdf")))
plot_master_dr_by_ae(preds = dr_ae_plot$preds, outfile = file.path(master_dir, paste0("master_dr_by_ae_", tag, ".pdf")), significant_only = FALSE)
}, silent = TRUE)
# --- paper figs (session only, per model)
if (w == "session") {
make_paper_figures_for_window(
window_value = "session",
es = es,
dr_mol_plot = dr_mol_plot,
dr_ae_plot  = dr_ae_plot,
out_dir = out_tag,
model = spec$model,
df_spline = df_spline,
only_session = TRUE
)
}
list(mol_obs = dr_mol_obs, ae_obs = dr_ae_obs, mol_plot = dr_mol_plot, ae_plot = dr_ae_plot)
})
list(es = es, dr = dr)
}
results <- purrr::map(windows, run_window)
names(results) <- windows
results <- purrr::compact(results)
if (all(c("session","follow_up") %in% names(results))) {
message("→ Paper comparison figures (session vs follow-up): linear + spline")
make_paper_figures_comparison(results, out_dir = out_dir, df_spline = df_spline)
} else {
message("⚠️ Follow-up window missing: comparison not produced.")
}
invisible(results)
}
if (identical(environment(), globalenv())) {
run_main_analysis()
}
